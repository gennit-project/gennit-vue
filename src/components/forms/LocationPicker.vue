<script lang="ts">
import { defineComponent, ref, computed } from "vue";
import { distanceOptions, distanceUnitOptions } from "@/components/event/eventSearchOptions";
import Select from "@/components/forms/Select.vue";
import RadioButtons from "@/components/forms/RadioButtons.vue";
import LocationSearchBar from "@/components/forms/LocationSearchBar.vue";
import LocationFilterTypes from "../event/locationFilterTypes";
import { DistanceUnit, Distance } from "@/types/eventTypes";

const locationFilterMap = LocationFilterTypes

export const locationFilterOptions = [
  {
    value: LocationFilterTypes.NONE,
    label: "Both virtual and in-person events",
  },
  {
    value: LocationFilterTypes.ONLY_VIRTUAL,
    label: "Virtual only",
  },
  {
    value: LocationFilterTypes.ONLY_WITH_ADDRESS,
    label: "In-person only",
  },
  {
    value: LocationFilterTypes.WITHIN_RADIUS,
    label: "Within a radius of an address",
  },
];
// const getLocationFilterMap = () => {
//   const filterMap = {} as any;
//   for (let i = 0; i < locationFilterOptions.length; i++) {
//     const filterType = locationFilterOptions[i].value;
//     const filterLabel = locationFilterOptions[i].label;
//     filterMap[filterType] = {
//       value: filterType,
//       label: filterLabel
//     };
//   }
//   return filterMap;
// }

export default defineComponent({
  components: {
    Select,
    RadioButtons,
    LocationSearchBar,
  },
  setup(props) {
    const defaultDistanceUnit: DistanceUnit = { label: "km", value: "km" };
    const locationFilter = ref(props.selectedLocationFilter);
    const selectedDistanceUnit = ref(defaultDistanceUnit);

    const getDistanceOptions = (label: string) => {
      return distanceOptions.map((option) => {
        return {
          ...option,
          label: `${option[label].toLocaleString()} ${label}`,
        };
      });
    };

    const unitLabel = selectedDistanceUnit.value.label.toString();

    const distanceOptionsWithLabel: any = ref(getDistanceOptions(unitLabel));

    const selectedDistance = ref({ ...distanceOptionsWithLabel.value[0] });

    const selectedLocationFilterString = ref(props.selectedLocationFilter)
    const selectedLocationFilterOption = computed(() => {
      return locationFilterMap[selectedLocationFilterString.value]
    })

    return {
      getDistanceOptions,
      locationFilterOptions,
      LocationFilterTypes,
      locationFilter,
      locationFilterMap,
      distanceOptions,
      distanceUnitOptions,
      distanceOptionsWithLabel,
      selectedDistance,
      selectedDistanceUnit,
      selectedLocationFilterString,
      selectedLocationFilterOption
    };
  },
  props: {
    selectedLocationFilter: {
      type: String,
      required: true,
    },
    referencePointAddressName: {
      type: String,
      default: ""
    }
  },
  methods: {
    updateLocationInput(placeData: any) {
      this.$emit("updateLocationInput", placeData);
      this.selectedLocationFilterString = LocationFilterTypes.WITHIN_RADIUS;
    },
    updateSelectedDistanceUnit(unitOption: DistanceUnit) {
      this.selectedDistanceUnit = unitOption;
      this.distanceOptionsWithLabel = this.getDistanceOptions(unitOption.label);
      this.selectedDistance.label = `${
        this.selectedDistance[unitOption.label].toLocaleString()
      } ${unitOption.label}`;
      this.$emit('updateDistanceUnit', unitOption.value)
    },
    updateSelectedDistance(radius: Distance) {
      this.selectedDistance = radius;
      this.$emit('updateRadius', radius.km)
    },
    updateSelectedLocationFilter(selected: any){
      this.$emit('updateLocationFilter', selected.value)
    }
  },
});
</script>

<template>
  <div>
    <RadioButtons
      :selected-option="selectedLocationFilterOption"
      :options="locationFilterOptions"
      @updateSelected="updateSelectedLocationFilter"
    />
    <div
      id="radiusOptions"
      class="ml-7 mt-2"
    >
      <label class="block text-xs font-medium text-gray-700 mt-2"
        >Near this Address</label
      >
      <LocationSearchBar
        :search-placeholder="'Address'"
        :reference-point-address-name="referencePointAddressName"
        @updateLocationInput="updateLocationInput"
      />
      <Select
        :select-label="'Within Radius'"
        :selected-option="selectedDistance"
        :options="distanceOptionsWithLabel"
        @updateSelected="updateSelectedDistance"
      />
      <Select
        :select-label="'Distance Unit'"
        :selected-option="selectedDistanceUnit"
        :options="distanceUnitOptions"
        @updateSelected="updateSelectedDistanceUnit"
      />
    </div>
  </div>
</template>